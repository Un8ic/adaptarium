// ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
const profile = {
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    loadProfileData() {
        const profileData = this.getUserProfileData();
        const savedPhoto = utils.getUserData('userPhoto');
        
        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑĞµÑÑĞ¸Ğ¸
        if (auth.currentUser) {
            document.getElementById('profile-display-name').textContent = auth.currentUser.name;
            document.getElementById('profile-name').value = auth.currentUser.name;
        }
        
        if (profileData.position) {
            document.getElementById('profile-display-position').textContent = profileData.position;
            document.getElementById('profile-position').value = profileData.position;
        } else {
            const position = auth.currentUser.role === 'admin' ? 'Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶' : 'ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°Ğ¼';
            document.getElementById('profile-display-position').textContent = position;
            document.getElementById('profile-position').value = position;
        }
        
        if (savedPhoto) {
            document.getElementById('profile-photo').src = savedPhoto;
        }
        
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°ĞºĞ²Ğ°Ñ€Ğ¸ÑƒĞ¼
        this.loadProgress();
        this.updateAquarium();
    },
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    getUserProfileData() {
        if (!auth.currentUser) return {};
        
        const userProgress = auth.getUserProgress();
        return userProgress.profile || {};
    },
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    saveUserProfileData(profileData) {
        if (!auth.currentUser) return false;
        
        const userProgress = auth.getUserProgress();
        userProgress.profile = profileData;
        return auth.saveUserProgress(userProgress);
    },
    
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ° Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ
    loadProgress() {
        if (!auth.currentUser) return;
        
        // ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²
        const materials = ['company-intro', 'products-services', 'sales-techniques', 
                          'objection-handling', 'negotiation', 'customer-centric'];
        let completedMaterials = 0;
        
        materials.forEach(material => {
            if (materials.getMaterialStatus(material) === 'completed') {
                completedMaterials++;
            }
        });
        
        const materialsProgress = Math.round((completedMaterials / materials.length) * 100);
        document.getElementById('materials-progress').textContent = materialsProgress + '%';
        
        // ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ (Ğ¸Ğ³Ñ€)
        const gamesList = ['quest', 'quiz'];
        let completedGames = 0;
        
        gamesList.forEach(game => {
            if (games.getGameProgress(game)) {
                completedGames++;
            }
        });
        
        const trainingProgress = Math.round((completedGames / gamesList.length) * 100);
        document.getElementById('training-progress').textContent = trainingProgress + '%';
        
        // ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
        const testsList = ['products-test', 'sales-test', 'objections-test'];
        let completedTests = 0;
        
        testsList.forEach(test => {
            if (tests.getTestStatus(test) === 'completed') {
                completedTests++;
            }
        });
        
        const testsProgress = Math.round((completedTests / testsList.length) * 100);
        document.getElementById('tests-progress').textContent = testsProgress + '%';
        
        // ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
        const totalProgress = Math.round((materialsProgress + trainingProgress + testsProgress) / 3);
        document.getElementById('total-progress').textContent = totalProgress + '%';
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ°ĞºĞ²Ğ°Ñ€Ğ¸ÑƒĞ¼Ğµ
        this.progress = {
            materials: materialsProgress,
            training: trainingProgress,
            tests: testsProgress,
            total: totalProgress
        };
    },
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºĞ²Ğ°Ñ€Ğ¸ÑƒĞ¼Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
    updateAquarium() {
        const aquarium = document.getElementById('aquarium');
        if (!aquarium) return;
        
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ°ĞºĞ²Ğ°Ñ€Ğ¸ÑƒĞ¼ (ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¾Ğ²)
        const bubbles = aquarium.querySelector('.bubbles');
        aquarium.innerHTML = '';
        if (bubbles) {
            aquarium.appendChild(bubbles);
        } else {
            const newBubbles = document.createElement('div');
            newBubbles.className = 'bubbles';
            aquarium.appendChild(newBubbles);
        }
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€Ñ‹Ğ±Ğ¾Ğº Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
        this.addFishBasedOnProgress();
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
        this.addAccessoriesBasedOnProgress();
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¸
        this.addBubbles();
    },
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€Ñ‹Ğ±Ğ¾Ğº Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
    addFishBasedOnProgress() {
        const aquarium = document.getElementById('aquarium');
        const totalProgress = this.progress.total;
        
        // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ñ‹Ğ±Ğ¾Ğº Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
        let fishCount = 0;
        
        if (totalProgress >= 20) fishCount = 1;  // 1 Ñ€Ñ‹Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ 20%
        if (totalProgress >= 40) fishCount = 2;  // 2 Ñ€Ñ‹Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ 40%
        if (totalProgress >= 60) fishCount = 3;  // 3 Ñ€Ñ‹Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ 60%
        if (totalProgress >= 80) fishCount = 4;  // 4 Ñ€Ñ‹Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ 80%
        if (totalProgress >= 95) fishCount = 5;  // 5 Ñ€Ñ‹Ğ±Ğ¾Ğº Ğ¿Ñ€Ğ¸ 95%+
        
        const fishTypes = ['ğŸ ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ '];
        
        for (let i = 0; i < fishCount; i++) {
            const fish = document.createElement('div');
            fish.className = `fish fish-${i + 1}`;
            fish.textContent = fishTypes[i];
            fish.style.animationDelay = `${i * 2}s`;
            aquarium.appendChild(fish);
        }
    },
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
    addAccessoriesBasedOnProgress() {
        const aquarium = document.getElementById('aquarium');
        const materialsProgress = this.progress.materials;
        const trainingProgress = this.progress.training;
        const testsProgress = this.progress.tests;
        
        // Ğ Ğ°ÑÑ‚ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞµ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²
        if (materialsProgress >= 30) {
            const plant1 = document.createElement('div');
            plant1.className = 'aquarium-accessory plant-1';
            plant1.textContent = 'ğŸŒ¿';
            aquarium.appendChild(plant1);
        }
        
        if (materialsProgress >= 60) {
            const plant2 = document.createElement('div');
            plant2.className = 'aquarium-accessory plant-2';
            plant2.textContent = 'ğŸŒ±';
            aquarium.appendChild(plant2);
        }
        
        // ĞšĞ°Ğ¼Ğ½Ğ¸ Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞµ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ
        if (trainingProgress >= 30) {
            const stone1 = document.createElement('div');
            stone1.className = 'aquarium-accessory stone-1';
            stone1.textContent = 'ğŸª¨';
            aquarium.appendChild(stone1);
        }
        
        if (trainingProgress >= 60) {
            const stone2 = document.createElement('div');
            stone2.className = 'aquarium-accessory stone-2';
            stone2.textContent = 'â›°ï¸';
            aquarium.appendChild(stone2);
        }
        
        // Ğ¡Ğ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
        if (testsProgress >= 50) {
            const treasure = document.createElement('div');
            treasure.className = 'aquarium-accessory treasure';
            treasure.textContent = 'ğŸ’';
            aquarium.appendChild(treasure);
        }
    },
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¾Ğ²
    addBubbles() {
        const bubblesContainer = document.querySelector('.bubbles');
        if (!bubblesContainer) return;
        
        bubblesContainer.innerHTML = '';
        
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¾Ğ²
        for (let i = 0; i < 15; i++) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¾Ğ²
            const size = Math.random() * 20 + 5;
            const left = Math.random() * 100;
            const delay = Math.random() * 8;
            const duration = Math.random() * 4 + 6;
            
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.left = `${left}%`;
            bubble.style.animationDelay = `${delay}s`;
            bubble.style.animationDuration = `${duration}s`;
            
            bubblesContainer.appendChild(bubble);
        }
    },
    
    // Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    enableEditMode() {
        document.getElementById('edit-profile-section').style.display = 'block';
        document.getElementById('edit-profile-btn').style.display = 'none';
    },
    
    // ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    disableEditMode() {
        document.getElementById('edit-profile-section').style.display = 'none';
        document.getElementById('edit-profile-btn').style.display = 'block';
    },
    
    // ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    cancelEdit() {
        this.disableEditMode();
        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        this.loadProfileData();
    },
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾
    updatePhoto() {
        const fileInput = document.getElementById('photo-upload');
        const file = fileInput.files[0];
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profile-photo').src = e.target.result;
                // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                utils.saveUserData('userPhoto', e.target.result);
                utils.showNotification('Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾');
            };
            reader.readAsDataURL(file);
        } else {
            utils.showNotification('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸', true);
        }
    },
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    updateProfile() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (newPassword && newPassword !== confirmPassword) {
            utils.showNotification('ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚', true);
            return;
        }
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        const profileData = {
            name: document.getElementById('profile-name').value,
            position: document.getElementById('profile-position').value
        };
        
        this.saveUserProfileData(profileData);
        
        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        document.getElementById('profile-display-name').textContent = profileData.name;
        document.getElementById('profile-display-position').textContent = profileData.position;
        
        if (newPassword) {
            // Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ´ĞµÑÑŒ Ğ±Ñ‹Ğ» Ğ±Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
            utils.showNotification('ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹');
        } else {
            utils.showNotification('ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
        }
        
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ· Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        this.disableEditMode();
    }
};
